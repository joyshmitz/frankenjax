{
  "schema_version": "frankenjax.perf-evidence.v1",
  "optimization_name": "bitset_fast_path",
  "author": "SageKite",
  "created_at": "2026-02-15T00:50:00Z",
  "hotspot_identification": {
    "method": "criterion_benchmark_profiling",
    "hotspot": "fj_interpreters::partial_eval::partial_eval_jaxpr + dce_jaxpr",
    "evidence": "FxHashSet<VarId> used for unknown_vars, residual_set, and needed sets â€” hash computation and bucket traversal dominates for small-to-medium Jaxprs. Second pass over equations builds another FxHashSet unconditionally.",
    "root_cause": "Hash-based set operations (insert/contains) have per-element hashing overhead that exceeds the cost of indexed lookup for compact VarId spaces"
  },
  "optimization_applied": {
    "lever": "varid_indexed_bitset_with_fast_path_shortcuts",
    "description": "Two optimizations applied: (1) Replace FxHashSet<VarId> with Vec<bool> indexed by VarId.0 for O(1) lookup without hashing. (2) Add fast-path returns for all-known and all-unknown cases that skip the classification loop entirely, constructing results directly from the input Jaxpr.",
    "files_changed": [
      "crates/fj-interpreters/src/partial_eval.rs"
    ],
    "commit_scope": "single optimization lever as required by bd-3dl.14.8"
  },
  "metrics": {
    "before": {
      "pe_all_known_10eq_ns": 569,
      "pe_all_unknown_10eq_ns": 1125,
      "pe_mixed_neg_mul_ns": 300,
      "pe_all_known_100eq_ns": 4460,
      "pe_all_known_1000eq_ns": 42949,
      "pe_program_spec_square_plus_linear_ns": 195,
      "dce_all_used_10eq_ns": 832,
      "dce_all_used_100eq_ns": 6713,
      "dce_all_used_1000eq_ns": 65958,
      "staging_neg_mul_mixed_ns": 654,
      "staging_all_known_add2_ns": 330,
      "staging_chain_100eq_ns": 10751
    },
    "after": {
      "pe_all_known_10eq_ns": 478,
      "pe_all_unknown_10eq_ns": 493,
      "pe_mixed_neg_mul_ns": 297,
      "pe_all_known_100eq_ns": 4090,
      "pe_all_known_1000eq_ns": 40067,
      "pe_program_spec_square_plus_linear_ns": 179,
      "dce_all_used_10eq_ns": 601,
      "dce_all_used_100eq_ns": 4913,
      "dce_all_used_1000eq_ns": 46450,
      "staging_neg_mul_mixed_ns": 686,
      "staging_all_known_add2_ns": 300,
      "staging_chain_100eq_ns": 10062
    },
    "improvement": {
      "pe_all_known_10eq_percent": 16.0,
      "pe_all_unknown_10eq_percent": 56.2,
      "pe_mixed_neg_mul_percent": 1.0,
      "pe_all_known_100eq_percent": 8.3,
      "pe_all_known_1000eq_percent": 6.7,
      "pe_program_spec_square_plus_linear_percent": 8.2,
      "dce_all_used_10eq_percent": 27.8,
      "dce_all_used_100eq_percent": 26.8,
      "dce_all_used_1000eq_percent": 29.6,
      "staging_all_known_add2_percent": 9.1,
      "staging_chain_100eq_percent": 6.4
    }
  },
  "isomorphism_proof": {
    "tests_passed": "67/67 fj-interpreters + 20/20 pe_staging_oracle + 6/6 e2e_p2c003 + 8/8 e2e",
    "differential_oracle_status": "20/20 oracle tests pass (pe_staging_oracle.rs)",
    "staging_roundtrip": "200/200 roundtrip comparisons pass (staging_roundtrip E2E scenario)",
    "e2e_scenarios": "6/6 P2C-003 E2E scenarios pass with forensic logs",
    "metamorphic_properties": "5/5 metamorphic properties verified (determinism, idempotency)",
    "adversarial_cases": "8/8 adversarial edge cases pass"
  },
  "regressions": {
    "detected": false,
    "notes": "staging/neg_mul_mixed shows ~5% noise-level variation (686ns vs 654ns, within measurement uncertainty). All other benchmarks improved."
  },
  "benchmark_targets": {
    "pe_10eq_50pct_known_target_us": 5.0,
    "pe_10eq_50pct_known_actual_us": 0.297,
    "constant_fold_10eq_all_known_target_us": 2.0,
    "constant_fold_10eq_all_known_actual_us": 0.478,
    "dce_10eq_target_us": 1.0,
    "dce_10eq_actual_us": 0.601,
    "all_targets_met": true
  }
}
